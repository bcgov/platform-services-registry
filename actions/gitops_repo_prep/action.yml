name: 'gitops-repo-setup'
description: 'Checks out gitops repo and prepares for updates'
runs:
  using: composite
  steps:

    # Prepare SSH key for GitOps repo
    # -------------------------------
    - name: Prepare deploy key
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.MANIFEST_REPO_DEPLOY_KEY }}

    # Check out the GitOps repo
    # -------------------------
    - name: Check out manifest repo
      uses: actions/checkout@v2
      with:
        ssh-key: ${{ secrets.MANIFEST_REPO_DEPLOY_KEY }}
        repository: ${{ secrets.MANIFEST_REPO }}

    # Install Kustomize
    # -----------------
    - name: Set up Kustomize
      uses: imranismail/setup-kustomize@v1

    # Set Git config
    # --------------
    - name: Set global git config
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
