name: 06.Deploy Maintenance Dispatch

on:
  workflow_dispatch:
    inputs:
      maintenanceMode:
        description: Enable Maintenance Mode
        type: choice
        required: true
        options:
        - 'true'
        - 'false'
      imageTag:
        description: Image Tag Version (ghcr.io/bcgov/pltsvc:<imageTag>)
        type: string
        required: true

jobs:
  toggle-maintenance:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: read
      actions: write

    steps:
    - name: Authenticate and set context
      uses: redhat-actions/oc-login@dfbd9912672664f9df2023c1c16e07bcf306043c
      with:
        openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
        namespace: ${{ vars.OPENSHIFT_NAMESPACE }}
        insecure_skip_tls_verify: true

    - name: Toggle Maintenance Mode
      run: |
        export MAINTENANCE_MODE=${{ inputs.maintenanceMode }}
        echo "Setting maintenance mode to $MAINTENANCE_MODE"
        yq e -i '.maintenance.enabled = strenv(MAINTENANCE_MODE)' helm/_app/values.yaml
      env:
        MAINTENANCE_MODE: ${{ inputs.maintenanceMode }}

    - name: Deploy updated Helm chart
      run: |
        make upgrade \
        NAMESPACE=${{ vars.OPENSHIFT_NAMESPACE }} \
        IMAGE_TAG=${{ inputs.imageTag }}
      working-directory: ./helm/main

    - name: Trigger Maintenance Image Build
      if: inputs.maintenanceMode == 'true'
      run: |
        curl -X POST -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
        https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-push-maintenance.yml/dispatches \
        -d '{"ref":"main"}'
