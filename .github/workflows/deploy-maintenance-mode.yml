name: 06.Deploy Maintenance Mode

on:
  workflow_dispatch:

env:
  GITHUB_REGISTRY: ghcr.io
  MAINTENANCE_BRANCH: feat/4829

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write
  contents: write
  security-events: write

jobs:
  build-push-maintenance:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
    - name: Checkout maintenance branch
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MAINTENANCE_BRANCH }}

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GITHUB_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: maintenance-page
        push: true
        tags: ${{ env.GITHUB_REGISTRY }}/maintenance-mode:latest

  deploy-maintenance:
    runs-on: ubuntu-22.04
    needs: build-push-maintenance
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Authenticate to OpenShift
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
        namespace: ${{ vars.OPENSHIFT_NAMESPACE }}
        insecure_skip_tls_verify: true

    - name: Deploy Maintenance Mode
      run: |
        oc apply -f k8s/maintenance-deployment.yaml
        oc apply -f k8s/maintenance-service.yaml
        oc apply -f k8s/maintenance-route.yaml || echo "Route not required"

    - name: Verify Deployment
      run: oc rollout status deployment/maintenance-mode -n ${{ vars.OPENSHIFT_NAMESPACE }}

    - name: Notify RocketChat on Failure
      if: failure()
      uses: ./.github/actions/rocketchat-notification
      with:
        webhook-url: ${{ secrets.ROCKETCHAT_WEBHOOK_URL }}
        data: |
          {
            "text": ":warning: Maintenance Mode Deployment Failed! Check the logs."
          }
