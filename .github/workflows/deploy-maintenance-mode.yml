name: 06.Deploy Maintenance Mode

on:
  workflow_dispatch:

env:
  GITHUB_REGISTRY: ghcr.io

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write
  contents: read

jobs:
  deploy-maintenance:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
    - uses: hmarr/debug-action@f7318c783045ac39ed9bb497e22ce835fdafbfe6
    - uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2

    - name: Authenticate to OpenShift
      uses: redhat-actions/oc-login@dfbd9912672664f9df2023c1c16e07bcf306043c
      with:
        openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
        namespace: ${{ vars.OPENSHIFT_NAMESPACE }}
        insecure_skip_tls_verify: true

    - name: Deploy Maintenance Mode
      run: |
        helm upgrade --install maintenance-mode helm/maintenance-chart \
          --namespace=${{ vars.OPENSHIFT_NAMESPACE }} \
          --set image.tag=latest

    - name: Verify Deployment
      run: kubectl rollout status deployment/maintenance-mode -n ${{ vars.OPENSHIFT_NAMESPACE }}
