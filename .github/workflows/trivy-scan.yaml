name: Scan with Trivy

on:
  workflow_dispatch:  # Allows manual triggering via GitHub CLI or UI

env:
  GITHUB_REGISTRY: ghcr.io

jobs:
  trivy_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to GitHub Container Registry
      env:
        REGISTRY_URL: ${{ env.GITHUB_REGISTRY }}
        REGISTRY_USERNAME: ${{ github.actor }}
        REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      run: echo $REGISTRY_PASSWORD | docker login $REGISTRY_URL -u $REGISTRY_USERNAME --password-stdin

    - name: Scan Image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ inputs.image-ref }}
        format: table
        ignore-unfixed: true
        vuln-type: os,library
        severity: LOW,MEDIUM,CRITICAL,HIGH
