# Development Sandbox

The development sandbox serves as an isolated environment for local development and testing, separate from the live system. This setup grants full control over local data and mock interfaces.

## Getting Started

1. To begin, duplicate the `.env.example` file to create a `.env.local` file and a `.env.test` file. The `.env.local` file is used to define default environment variables for local development, while the `.env.test` file is specifically for testing purposes.
   Ensure `.env.local` and `.env.test` are in the root directory of the project (`/app`). This ensures that they are correctly picked up by the application when required.

2. Switch to sandbox folder

```bash
cd sandbox
```

3. Create three directories to mount volumns for `mongodb`,`postgres` and `mailpit`.

```bash
mkdir -p ./mnt/mongodb
mkdir -p ./mnt/postgres
mkdir -p ./mnt/mailpit
```

If you have data version conflict errors due to existing mount volumes, please delete the directories and recreate them.

4. Set environment variable MACHINE_HOST_IP to your ip address using the command

For WSL/Linux:

```bash
export MACHINE_HOST_IP=$(hostname -I | awk '{print $1}')
```

or
For Mac M1/M2:

```bash
export MACHINE_HOST_IP=$(ipconfig getifaddr en0)
```

5. To create the sandbox environment, utilize local Docker container instances with `docker-compose`:

For WSL/Linux:

```bash
docker-compose up --build [-d]
```

or
For Mac M1/M2:

```bash
docker-compose -f docker-compose.yml -f docker-compose-arm64.yml up --build [-d]
```

You can add the `-d` flag to run the containers in daemon mode.

Ensure that neither `MongoDB` nor `Mongosh` is installed on your local machine, as they may interfere with the database schema managed by Prisma, which connects to the `MongoDB Docker container`. If you have either installed, you can remove them by following the instruction provided in this link: [uninstall mongodb and mongosh](https://www.mongodb.com/resources/products/fundamentals/uninstall-mongodb#:~:text=How%20to%20uninstall%20MongoDB%20from%20Mac%201%20If,the%20below%20command%3A%20brew%20uninstall%20mongodb-community%20%20)

## Services

Within the local Docker container context, `5 services` are established:

1. `Keycloak`: Facilitates user authentication for the application via Browser Login.
2. `Keycloak Provision`: Provisions the local Keycloak's realm, clients, and users.
3. `Postgres`: Serves as the database for Keycloak.
4. `MongoDB`: Serves as the database for the local application.
   - Please refer to [MongoDB Compass](https://www.mongodb.com/products/tools/compass) to explore the local database.
5. `Microsoft 365 Developer Proxy`: Serves as a proxy server for Microsoft Graph APIs.
   - Please refer to https://github.com/microsoft/m365-developer-proxy for more detailed information.
6. `CHES Mock`: Simulates the CHES (Common Hosted Email Service) for local email delivery and testing.
7. `Mailpit`: Provides a lightweight email testing tool to capture and inspect outgoing emails.

- Please refer to [Mailpit GitHub Repository](https://github.com/axllent/mailpit) for more detailed information.

- Please refer to [docker-compose.yml](./docker-compose.yml) for more detailed information.

### Important Information

- `Keycloak HTTP`: http://localhost:8080
- `Keycloak HTTPS`: https://localhost:8443
- `Keycloak Realm`: platform-services
- `Keycloak Client ID`: pltsvc
- `Keyclaok Client Secret`: testsecret
- `MongoDB URL`: mongodb@localhost:27017
- `Microsoft 365 Proxy Url`: http://localhost:8000
- `CHES Mock URL`: http://localhost:3025
- `Mailpit URL`: http://localhost:8025
- Please refer to [.env.example](../.env.example) for comprehensive local environment values.
- Please refer to [m365proxy/mocks.json](./m365proxy/mocks.json) for local mock user list.
  - The passwords for users are generated by converting their emails to lowercase.
  - See https://learn.microsoft.com/en-us/microsoft-cloud/dev/dev-proxy/how-to/mock-responses for more information.
